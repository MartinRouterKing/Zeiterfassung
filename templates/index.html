{% extends "base.html" %}

{% block content %}

<style>

.fc-title:hover{
    z-index: 20 !important;
    overflow: visible !important;
    opacity: .99;
    background-color: #007bff;
}

.test{
    background-color: rgba(2,8,24,0.8);
    margin: 10px;
}

th, td, h2{
    color: white
}
.fc-time-grid-event{
    background-color: #343a40;
    border: 1px solid #343a40;
    border-left: 5px solid Navy;
}

.fc-event{

    z-index: 0;
    position: relative;
    background-color: #343a40;
}
  body {
  background-attachment: fixed;
  padding-top: 0px;
  z-index: 0;
  }


</style>
<div class="container">
  <!-- Content here -->
    <div class="row">
        <div class="col">
            <div class="test" id='external-events'>
                    <span class= "align-baseline">
                        <div>
                            <form method="post">
                                <select class="form-control" id = "id_categories" name="categories" style="width:100%;max-width:90%;">
                                    {% for cat in categorie %}
                                    <option id="opt" value={{cat.id}}>{{ cat }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                            <div id = "id_element" class=form-control">
                            </div>
                            <input class="form-control" type='checkbox' id='drop-remove' />
                            <label class="form-control" for='drop-remove'>remove after drop</label>
                        </div>
                    </span>
            </div>
        </div>
        <div class="col-9">
                <div class="test">
                    <div>
                <span class= "align-baseline">
                    <div id='calendar-container'>
                        <div id='calendar'></div>
                    </div>
                </span>
                    </div>
                </div>
            </div>
        </div>
</div>

<script>
    $("#id_categories").change(function () {
      var categoriesId = $(this).val();                         // get the selected country ID from the HTML input
      $.ajax({                                                  // initialize an AJAX request
        url: 'load_elements/',                                  // set the url of the request (= localhost:8000/hr/ajax/element/)
        data: {
          'categories': categoriesId                            // add the country id to the GET parameters
        },
        success: function (data) {                              // `data` is the return of the `load_element` view function
          $("#id_element").html(data)

         $('#id_element .fc-event').each(function() {
                                                                // store data so the calendar knows to render an event upon drop
           $(this).data('event', {
            title: $.trim($(this).text()),                      // use the element's text as the event title
            type: categoriesId,
            stick: true,                      // maintain when user navigates (see docs on the renderEvent method)
            duration: '01:00:00'              // will set the duration during drag of event
            });

        $('#id_element .fc-event').draggable({
        helper: 'clone',
        zIndex: 999,
        revert: true,      // will cause the event to go back to its
        revertDuration: 0  //  original position after the drag
        });

        });
        }
        });
     });

</script>



<script type="text/javascript">
    $(function() {

  // initialize the external events
  // -----------------------------------------------------------------

  $('#id_element .fc-event').each(function() {

    // store data so the calendar knows to render an event upon drop

    $(this).data('event', {
      title: $.trim($(this).text()), // use the element's text as the event title
      stick: true, // maintain when user navigates (see docs on the renderEvent method)
      duration: '01:00:00' // will set the duration during drag of event
     });

    // make the event draggable using jQuery UI

    $(this).draggable({
      zIndex: 999,
      revert: true,      // will cause the event to go back to its
      revertDuration: 0  //  original position after the drag
    });
    });

  // initialize the calendar
  // -----------------------------------------------------------------

  function saveMyData(event){
    $.ajax({
          type: 'POST',
          url: 'post/',
          data: {
                action: 'save',
                id: event.id,
                title: event.title,
                type: event.type,
                start: event.start.toString(),
                end:   event.end.toString(),
                note: event.note,
                csrfmiddlewaretoken: '{{ csrf_token }}'
          },
    });
    }


  function deleteMyData(event){
    $.ajax({
          type: 'POST',
          url: 'post/',
          data: {
                action: 'delete',
                id: event.id,
                title: event.title,
                start: event.start.toString(),
                end:   event.end.toString(),
                note: event.note,
                csrfmiddlewaretoken: '{{ csrf_token }}'
          },
    });
    }

   var latest_id = {{ latest_id }};

  $('#calendar').fullCalendar({

    defaultView: (function (){ if($(window).width()<=768){
        return defaultView = 'agendaDay';} else { return defaultView = 'agendaWeek';}})(),

    slotLabelFormat: [
        'MMMM YYYY', // top level of text
        'HH:mm'        // lower level of text
    ],
    columnHeaderText: function(mom) {
    if (mom.weekday() === 0) {
      return 'Montag';}
      if (mom.weekday() === 1) {
      return 'Dienstag';}
      if (mom.weekday() === 2) {
      return 'Mittwoch';}
      if (mom.weekday() === 3) {
      return 'Donnerstag';}
      if (mom.weekday() === 4) {
      return 'Freitag';}
      if (mom.weekday() === 5) {
      return 'Samstag';}
      if (mom.weekday() === 6) {
      return 'Sonntag';}
     },
    allDaySlot: false,
    slotDuration: '00:30:00',
    minTime: '06:00:00',
    maxTime: '22:00:00',
    nowIndicator: true,
    eventTextColor: 'white',
    themeSystem: 'bootstrap4',
    height: $(window).height()*0.9,
    events: [
            {% for i in events %}
                {
                    id: "{{i.id}}",
                    title: "{{ i.title}}",
                    type: "{{ i.type.id }}",
                    start: "{{ i.start|date:"c" }}",
                    end: "{{ i.end|date:"c" }}",
                    note: "{{ i.note }}",
                    allDay: "{{ all_day }}",
                },
                {% endfor %}
            ],
            eventRender: function(event, element, view) {
                var colors = ['#1abc9c', '#2ecc71', '#3498db', '#9b59b6', '#34495e', '#f1c40f', '#e67e22', '#e74c3c', '#95a5a6'];
                var color = colors[event.type];
                element.css({"border-left": "5px solid "  + color});


            if (view.name == 'listDay') {
                element.find(".fc-list-item-time").append("<span class='closeon'>&times;</span>");
            } else {
                element.find(".fc-content").prepend("<span class='closeon'>&times;</span>");
            }
            element.find(".closeon").on('click', function () {
                deleteMyData(event);
                $('#calendar').fullCalendar('removeEvents', event._id);
            });
        },
    weekNumbers: true,
    color: 'white',
    firstDay: 1,
    textColor: 'white',
    editable: true,
    eventLimit: true,
    handleWindowResize: true,

    droppable: true, // this allows things to be dropped onto the calendar


    eventClick: function( event, jsEvent, view ) {
        var notiz = prompt("Notiz:", event.note);
        event_new = event;
        event_new.note = notiz;
        $('#calendar').fullCalendar('removeEvents', event._id);
        $('#calendar').fullCalendar( 'renderEvent', event_new , true );
        saveMyData(event_new);
    },

    eventReceive: function(event) {
            latest_id++;
            event.id = latest_id;
            event.note = ""
            event_new =event;
            $('#calendar').fullCalendar('removeEvents', event._id);
            $('#calendar').fullCalendar( 'renderEvent', event_new , true )
            saveMyData(event_new);
            },

    drop: function(date, jsEvent, ui, resourceId ) {
      // is the "remove after drop" checkbox checked?
      if ($('#drop-remove').is(':checked')) {
        // if so, remove the element from the "Draggable Events" list
        $(this).remove();
      }
    },

    eventDrop: function (event, delta, revertFunc, jsEvent, ui, view) {
               saveMyData(event);
           },

    eventResize: function (event, delta, revertFunc, jsEvent, ui, view) {
                 saveMyData(event);
             }
  });
  var $tooltip = $("<div>").text("I'm a tooltip").addClass("tooltip");
    $("#calendar").on("mouseenter",".fc-title", function(){
        $('tc-title').append($tooltip);
        console.log($(this));
        $tooltip.position({
            my:"left top",
            at:"middle middle",
            of:$(this),

        });
        console.log("in");
    }).on("mouseleave",".fc-title", function(){
        $tooltip = $tooltip.detach();
        console.log("out");
});


});

</script>
{% endblock %}
