{% extends "base.html" %}


{% load querystring from django_tables2 %}
{% block content %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>

    select{
        width: 100%;
        margin: 15px;
    }

    label{
        width: 100%;
    }

     .col{

        margin: 15px;
        width: 50%;
        margin-button: 0px;
        padding: 20px;
        color: white;
    }

    .test{

        background-color: #24282c;
        box-shadow: inset 0 0 10px #000000;
        margin: 10px;
        height: 90%;
        margin-top: 0px;
        padding: 20px;
    }



</style>

<link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>


<div class="row row-eq-height">
    <div class="col">
        <div class="test">
            <form method="post">
                <label>Auswahl der Mitarbeiter/-in:
                    <select class="form-control" id = "id_user">
                        <option selected="selected">--Alle--</option>
                        {% for u in form %}
                            <option>{{ u }}</option>
                        {% endfor %}
                    </select>
                </label>
            </form>
            <form method="post" id="id_cat">
                <label>Auswahl der Typen:
                    <select id="cat_select" class="form-control" multiple data-live-search="true" multiple data-actions-box="true">
                        {% for cat in categories %}
                        <option>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </label>
            </form>
            <form method="post" id="id_wie">
                <label>Auswahl der Wirtschaftseinheiten:
                    <select id="wie_select" class="form-control" multiple data-live-search="true" multiple data-actions-box="true">
                        {% for w in wie %}
                        <option>{{ w }}</option>
                        {% endfor %}
                    </select>
                </label>
            </form>
            <form method="post" id="id_obj">
                <label>Auswahl der Wirtschaftseinheiten:
                    <select id="obj_select" class="form-control" multiple data-live-search="true" multiple data-actions-box="true">
                        {% for o in obj %}
                        <option>{{ o }}</option>
                        {% endfor %}
                    </select>
                </label>
            </form>
            <button type="submit" id="sub_button" style="margin: 15px; height:13%; width: 20%;" onclick="calculate()" class="btn btn-primary" >Berechnen</button>
        </div>
    </div>
    <div class="col">
        <div class="test">

            <canvas id="bar-chart" ></canvas>
        </div>
    </div>
</div>

<script>


function gen_pie() {

    pie_labels = [];
    pie_values = [];
    var table = document.getElementsByTagName("table")[0];
    console.log(table.rows.length);
    console.log(table.rows[0].cells.length);
    var ges =  parseInt(table.rows[table.rows.length-1].cells[3].innerHTML);

    for (var c = 4; c< table.rows[0].cells.length; c++) {
        console.log("new cell");
        pie_labels.push(table.rows[0].cells[c].innerText);
        var percent = 0
        for (var i = 1; i< table.rows.length - 1; i++) {
            console.log("new row");
            if (table.rows[i].cells[c].innerHTML != "—") {

                var percent = percent + Math.round(parseFloat(table.rows[i].cells[c].innerHTML *100 / ges));
                console.log(percent);

            };
        };
        pie_values.push(percent);
    }


        Chart.defaults.global.defaultFontColor = 'white';
    var ctx = document.getElementById("bar-chart")
    new Chart(ctx, {
    type: 'bar',
    data: {
      labels: pie_labels,
                datasets: [
                    {
                    label: "Verteilung der Kostenträger in Prozent",
                    backgroundColor: ['#1abc9c', '#3498db', '#9b59b6', '#34495e', '#f1c40f', '#e67e22', '#e74c3c', '#95a5a6','#2ecc71',],
                    data: pie_values,
                    },

                    ],
                },

                options: {
                                    scales: {
                        yAxes: [{
                            display: true,
                                ticks: {
                                    min: 0,
                                    stepSize: 5
                                }
                            }],
                        xAxes: [{
                            ticks: {
                                display: false
                            }
                        }]
                        },
                    legend: {
                         labels: {
                         boxWidth: 0,
                        }
                    },
                    tooltips: {
                        enabled: true
                        },
                },
            });

}
</script>

<script>
    $('#cat_select').selectpicker();
    $('#wie_select').selectpicker();
    $('#obj_select').selectpicker();
    $('#id_user').selectpicker();
</script>


<script>

   function calculate() {
      var inner = '<i  id="load_icon" class="fa fa-spinner fa-pulse fa-3x fa-fw" style="font-size:18px; color:#f8f9fa;"></i>'

      load_icon = document.getElementById('sub_button');
      load_icon.innerHTML = inner;
      var cat_selected = $('#cat_select').val();
      var wie_selected = $('#wie_select').val();
      var obj_selected = $('#obj_select').val();
      var userId = $('#userId').val();

      $.ajax({
        type: "POST",
        url: "table/",
        data:{
            csrfmiddlewaretoken: '{{ csrf_token }}',
            'ca': cat_selected,
            'wie': wie_selected,
            'obj': obj_selected,
            'user': userId
            },
            success: function (data) {
            load_icon.innerHTML = 'Berechnen';
          $("#id_table").html(data);
          gen_pie();
        }
        });
};

</script>


<div class="test">
    <a class="btn btn-primary" type="submit" style="color: white;" onclick="ajax_exp()" role="button">Download</a>
<container id="id_table" >

</container>
    </div>
<script>
     function ajax_exp() {
        console.log("click");
        var table = document.getElementsByTagName("table")[0];
        var data = [];

        for (var c = 0; c< table.rows.length; c++) {
            console.log(c);
            rows = []
            for (var i = 0; i< table.rows[0].cells.length; i++) {
                if (c == 0){
                   rows.push(table.rows[c].cells[i].innerText);
                } else {
                   rows.push(table.rows[c].cells[i].innerHTML);
                }
            };
            data.push(rows);
        };
        console.log(data);

        let csvContent = "data:text/csv;charset=utf-8,";
        data.forEach(function(rowArray){
        let row = rowArray.join(",");
        csvContent += row + "\r\n";
        });

        var encodedUri = encodeURI(csvContent);
        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "my_data.csv");
        document.body.appendChild(link); // Required for FF
        link.click(); // This will download the data file named "my_data.csv".
     };
</script>



<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

{% endblock %}