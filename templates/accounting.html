{% extends "base.html" %}



{% block content %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>

    select{
        width: 100%;
        margin: 15px;
    }

    label{
        width: 100%;
    }


     .col{

        margin: 15px;
        width: 50%;
        margin-button: 0px;
        padding: 20px;
        color: white;
    }

    .test{

        background-color: #24282c;
        box-shadow: inset 0 0 10px #000000;
        margin: 10px;
        height: 90%;
        margin-top: 0px;
        padding: 20px;
    }



</style>

<link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>



<div class="row row-eq-height">
    <div class="col">
        <div class="test">
            <form method="post">
                <label>Auswahl der Mitarbeiter/-in:
                    <select class="form-control" id = "id_user">
                        <option selected="selected">--Alle--</option>
                        {% for u in form %}
                            <option>{{ u }}</option>
                        {% endfor %}
                    </select>
                </label>
            </form>
            <form method="post" id="id_cat">
                <label>Auswahl der Typen:
                    <select id="cat_select" class="form-control" multiple data-live-search="true" multiple data-actions-box="true">
                        {% for cat in categories %}
                        <option>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </label>
            </form>
            <form method="post" id="id_wie">
                <label>Auswahl der Wirtschaftseinheiten:
                    <select id="wie_select" class="form-control" multiple data-live-search="true" multiple data-actions-box="true">
                        {% for w in wie %}
                        <option>{{ w }}</option>
                        {% endfor %}
                    </select>
                </label>
            </form>
            <div id="load_icon" style="visibility: hidden; margin-top: 10px;">
                <i class="fa fa-spinner fa-pulse fa-3x fa-fw" style="font-size:24px; color:#337ab7; "></i>
                <span style="color: #337ab7; font-size:20px">Tabelle wird berechnet...</span>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="test">
            <canvas id="doughnut-chart" ></canvas>
        </div>
    </div>
</div>

<script>


function gen_pie() {

    pie_labels = [];
    pie_values = [];
    var table = document.getElementsByTagName("table")[0];
    console.log(table.rows.length);

    var ges =  parseInt(table.rows[table.rows.length-1].cells[3].innerHTML);

    for (var i = 1; i< table.rows.length - 1; i++) {
        if (table.rows[i].cells[3].innerHTML != "â€”") {
        pie_labels.push(table.rows[i].cells[2].innerHTML);
        var percent = parseFloat(table.rows[i].cells[3].innerHTML);
        console.log(percent);
        pie_values.push(Math.round((percent *100 / ges )*100)/100)
        }
    }

 var draw = Chart.controllers.doughnut.prototype.draw;
    Chart.controllers.doughnut = Chart.controllers.doughnut.extend({
    draw: function() {
        draw.apply(this, arguments);

        let canvas = this.chart.chart;
        ctx = canvas.ctx;
        let _fill = ctx.fill;

        var cw=canvas.width;
        var ch=canvas.height * 1.112;

        var radius = this.outerRadius;
        ctx.globalCompositeOperation='source-atop';


        ctx.shadowOffsetX = 500;
        ctx.shadowOffsetY = 0;
        ctx.shadowBlur = 10;
        ctx.shadowColor = 'rgba(0,0,0,1)';

        ctx.beginPath();
        ctx.arc(cw/2-500,ch/2,radius,0,Math.PI*2);
        ctx.stroke();
        ctx.stroke();
        ctx.stroke();


        ctx.globalCompositeOperation='source-over';


        ctx.fill = function() {
            ctx.save();

            _fill.apply(this, arguments)

        }
    }
    });


    new Chart(document.getElementById("doughnut-chart"), {
        type: 'doughnut',
        data: {
          labels: pie_labels,
          datasets: [
            {
              label: "Population (millions)",
              backgroundColor: ['#1abc9c', '#2ecc71', '#3498db', '#9b59b6', '#34495e', '#f1c40f', '#e67e22', '#e74c3c', '#95a5a6'],
              data: pie_values,
              hoverBorderWidth: 0,
              borderColor: "#24282c",
            }]
        },
        options: {
            segmentShowStroke : false,
            legend: {
                display: false
                },
        maintainAspectRatio: false,
          title: {
            display: true,
            text: 'Verteilung der Kategorien in %'
          }
        }
});


}
</script>



<script>

    $("#id_user").change(function () {
      load_icon = document.getElementById('load_icon');
      load_icon.style.visibility = 'visible';
      var userId = $(this).val();
      var cat_selected = $('#cat_select').val();
      var wie_selected = $('#wie_select').val();
      console.log(userId);
      $.ajax({
        type: "POST",
        url: "table/",
        data:{
            csrfmiddlewaretoken: '{{ csrf_token }}',
            'user': userId,
            'wie': wie_selected,
            'ca': cat_selected
            },
            success: function (data) {
            load_icon.style.visibility = 'hidden';

            $("#id_table").html(data);

            gen_pie();

        }
        });
    });


</script>



<script>
    $('#cat_select').selectpicker();
    $('#wie_select').selectpicker();
    $('#id_user').selectpicker();

   $('#cat_select').on('change', function () {
      load_icon = document.getElementById('load_icon');
      load_icon.style.visibility = 'visible';
      var cat_selected = $('#cat_select').val();
      var wie_selected = $('#wie_select').val();
      var userId = $('#userId').val();
      console.log($(this).val());
      $.ajax({
        type: "POST",
        url: "table/",
        data:{
            csrfmiddlewaretoken: '{{ csrf_token }}',
            'ca': cat_selected,
            'wie': wie_selected,
            'user': userId
            },
            success: function (data) {
            load_icon.style.visibility = 'hidden';
          $("#id_table").html(data);
          gen_pie();
        }
        });
    });

   $('#wie_select').on('change', function () {
      load_icon = document.getElementById('load_icon');
      load_icon.style.visibility = 'visible';
      var cat_selected = $('#cat_select').val();
      var wie_selected = $('#wie_select').val();
      var userId = $('#userId').val();
      console.log($(this).val());
      $.ajax({
        type: "POST",
        url: "table/",
        data:{
            csrfmiddlewaretoken: '{{ csrf_token }}',
            'ca': cat_selected,
            'wie': wie_selected,
            'user': userId
            },
            success: function (data) {
           load_icon.style.visibility = 'hidden';
          $("#id_table").html(data);
          gen_pie();
        }
        });
    });

</script>


<div class="test">
<container id="id_table" >



</container>
    </div>




<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

{% endblock %}